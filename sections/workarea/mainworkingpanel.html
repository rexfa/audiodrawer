<template class="task-template">
    <section id="mainworkingpanel-section" class="section mainworkingpanel-section u-category-mainworkingpanel">
        <div id="showone">
        </div>
        <div>
            <input id="sourceaudio" type="file">
        </div>
        <div>
            <button onclick="wavesurfer.playPause()">
                Play
            </button>
            <button class="btn btn-primary" onclick="setWavesutferSource()">
                <i class="glyphicon glyphicon-play"></i>
                Change
            </button>
            <button class="btn btn-primary" onclick="">
                <i class="glyphicon glyphicon-play"></i>
                Separate
            </button>
        </div>
        <script>
            const spawn = require('child_process').spawn;
            var childProcess = null;
            this.wavesurfer = WaveSurfer.create({
                container: "#showone",
                waveColor: "#368666",
                progressColor: "#6d9e8b",
                cursorColor: "#fff",
                height: 80,
                plugins: [WaveSurfer.regions.create()]
            });
            function setWavesutferSource() {
                // 不要用value取值
                if (document.getElementById('sourceaudio').files[0]) {
                    var audiopath = document.getElementById('sourceaudio').files[0].path;

                    this.wavesurfer.load(audiopath);
                    let duration = parseInt(this.wavesurfer.getDuration());
                    this.wavesurfer.stop();
                }
            }
            function runSpawnSeparate() {
                let iconv = require('iconv-lite');
                //spleeter separate -i audio_example.mp3 -o audio_output -p spleeter:4stems
                //spleeter:2stems
                //spleeter:4stems
                //spleeter:5stems
                let cmdStr = 'spleeter separate -i audio_example.mp3 -o audio_output -p spleeter:4stems';
                // 执行cmd命令的目录，如果使用cd xx && 上面的命令，这种将会无法正常退出子进程
                let cmdPath = './';
                // 子进程名称
                let workerProcess;
                var arr = [];
                var encodingName = "GBK";
                /*const productName = require('/package').productName
                switch (process.platform) {
                    case 'darwin':
                        encodingName = "utf8";
                        break;
                    case 'win32':
                        encodingName = "GBK";
                        break;
                    case 'freebsd':
                    case 'linux':
                    case 'sunos':
                        encodingName = "utf8";
                        break;
                    default:
                        throw new Error(`Unknown userDataPath path for platform ${process.platform}`)
                }*/
                // 执行命令行，如果命令不需要路径，或就是项目根目录，则不需要cwd参数：
                //增加GBK编码
                workerProcess = spawn(cmdStr, ['-t', 'www.163.com'], { cwd: cmdPath, encoding: encodingName });
                //可写流stdin暂不测试  stdio的[0][1][2] 已经由stdin stdout 和stderr 单独实现
                // 打印正常的后台可执行程序输出
                workerProcess.stdout.on('data', function (data) {
                    arr.push(data);
                    //console.log(data);
                    var arr1 = [];
                    arr1.push(data);
                    //console.log(" new data");
                    console.log(iconv.decode(Buffer.concat(arr1), encodingName));
                });
                // 打印错误的后台可执行程序输出
                workerProcess.stderr.on('data', function (data) {
                    console.log('stderr: ' + data);
                });
                // 退出之后的输出
                workerProcess.on('close', function (code) {
                    //console.log(arr); //utf8可能造成乱码
                    //console.log(iconv.decode(Buffer.concat(arr), encodingName)); // 改成GBK模式 
                    console.log('out code：' + code);
                });
                return workerProcess;
            }
            // 音频加载
            this.wavesurfer.load('./audios/example/yangzirong.mp3');
            // 获取总时长
            let duration = parseInt(this.wavesurfer.getDuration());
            // 停止播放并回到起始点
            this.wavesurfer.stop();
        </script>
    </section>
</template>